# Nombre del workflow que ver√°s en GitHub
name: üöÄ Deploy to AWS S3

# CU√ÅNDO se ejecutar√° este workflow:
on:
  # 1. Cuando hagas push a la rama main
  push:
    branches: [ "main" ]
  
  # 2. Cuando crees un Pull Request hacia main
  pull_request:
    branches: [ "main" ]
  
  # 3. Opcional: Permitir ejecuci√≥n manual desde GitHub
  workflow_dispatch:

# Variables de entorno que usaremos
env:
  AWS_REGION: 'us-east-1'  # Cambia si usas otra regi√≥n
  S3_BUCKET: 'mi-sitio-devops-2024'  # NOMBRE DE TU BUCKET S3

# LOS TRABAJOS (JOBS) que se ejecutar√°n
jobs:
  # PRIMER TRABAJO: Verificar y probar
  test:
    # Nombre que ver√°s en GitHub
    name: ‚úÖ Test and Validate
    # Sistema operativo donde correr√°
    runs-on: ubuntu-latest
    
    # Pasos a ejecutar
    steps:
      # 1. Descargar el c√≥digo del repositorio
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      # 2. Verificar que tenemos index.html
      - name: üîç Check HTML file exists
        run: |
          if [ ! -f "src/index.html" ]; then
            echo "‚ùå ERROR: No se encontr√≥ src/index.html"
            exit 1
          fi
          echo "‚úÖ index.html encontrado"
          ls -la src/
      
      # 3. Validar HTML b√°sico (opcional)
      - name: üìù Validate HTML
        run: |
          echo "Validando estructura HTML..."
          # Instalar herramienta de validaci√≥n
          sudo npm install -g html-validator-cli
          # Validar archivo
          html-validator --file=src/index.html || echo "‚ö†Ô∏è Advertencias en HTML"
      
      # 4. Probar que el sitio funciona localmente
      - name: üß™ Test with simple HTTP server
        run: |
          # Crear un servidor web temporal para probar
          python3 -m http.server 8080 --directory src &
          SERVER_PID=$!
          sleep 2
          
          # Hacer una petici√≥n a nuestro propio servidor
          curl -f http://localhost:8080/ || exit 1
          
          # Detener el servidor
          kill $SERVER_PID
          
          echo "‚úÖ Sitio funciona correctamente localmente"

  # SEGUNDO TRABAJO: Construir y desplegar
  deploy:
    # Depende de que el job 'test' haya pasado
    needs: test
    
    # Solo ejecutar si:
    # 1. Estamos en la rama main
    # 2. No es un Pull Request (solo push directo)
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    
    name: üöÄ Deploy to AWS S3
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar c√≥digo
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      # 2. Configurar AWS credentials (¬°IMPORTANTE!)
      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          # Estas variables las configuramos DESPU√âS en GitHub
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # 3. Sincronizar archivos con S3
      - name: üì§ Sync files to S3
        run: |
          echo "Subiendo archivos al bucket: ${{ env.S3_BUCKET }}"
          
          # Comando para subir archivos
          aws s3 sync ./src s3://${{ env.S3_BUCKET }} \
            --delete \  # Borra archivos en S3 que ya no existen localmente
            --acl public-read \  # Permisos p√∫blicos
            --cache-control "max-age=31536000,public"  # Cache por 1 a√±o
          
          echo "‚úÖ Archivos subidos exitosamente"
      
      # 4. Mostrar URL del sitio
      - name: üåê Show website URL
        run: |
          echo "========================================"
          echo "üéâ ¬°Sitio desplegado exitosamente!"
          echo ""
          echo "üåç URL de tu sitio:"
          echo "http://${{ env.S3_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
          echo ""
          echo "üìä Para ver en AWS Console:"
          echo "https://s3.console.aws.amazon.com/s3/buckets/${{ env.S3_BUCKET }}?region=${{ env.AWS_REGION }}&tab=objects"
          echo "========================================"